pkgname=termy-qt
pkgver=1.1.4
pkgrel=1
_pkgdir="termysequence-$pkgver"
pkgdesc="TermySequence terminal multiplexer client"
arch=('x86_64' 'i686')
url="https://termysequence.io"
license=('GPL2' 'LGPL3' 'CCPL:cc-by' 'BSD')
makedepends=('cmake>=3.9.0' 'qt5-base' 'qt5-svg' 'qt5-tools' 'systemd>=235'
             'ninja>=1.8.2' 'python2>=2.7' 'python2-jinja>=2.10' 'icu>=60.2')
checkdepends=('desktop-file-utils' 'appstream-glib')
depends=('fuse3' 'zlib' 'sqlite' 'qt5-base' 'qt5-svg' 'icu>=60.2' 'systemd>=235')
source=("termysequence-qt_$pkgver.orig.tar.xz")
sha256sums=('SKIP')

prepare() {
    cd $_pkgdir

    if [ "$CARCH" = 'x86_64' ]; then
        v8arch=x64;
    elif [ "$CARCH" = 'i686' ]; then
        v8arch=x86;
    else
        echo "Unsupported architecture '$CARCH'" 1>&2
        exit 1
    fi

    cmake \
        -DCMAKE_INSTALL_PREFIX:PATH=/usr \
        -DSYSCONF_INSTALL_DIR:PATH=/etc \
        -DSHARE_INSTALL_PREFIX:PATH=/usr/share \
        -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON \
        -DCMAKE_BUILD_TYPE=Release \
        -DV8_ARCH=$v8arch \
        .
}

build() {
    cd $_pkgdir

    # Conjure up a python->python2 environment
    mkdir -p py2
    ln -sf /usr/bin/python2 py2/python

    PATH="$(pwd)/py2:$PATH" make -j4
}

package() {
    cd $_pkgdir
    make DESTDIR="$pkgdir/" install install_emoji install_icons
    install -Dpm 644 vendor/v8-linux/v8/LICENSE.v8 $pkgdir/usr/share/licenses/$pkgname/LICENSE.v8
}
